<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Interactive Blackjack</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.8/browser/pixi.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family:'Roboto',sans-serif; background:linear-gradient(135deg,#1f1c2c,#928dab); color:#fff; text-align:center; padding:20px }
    h1 { font-size:3em; margin-bottom:20px; text-shadow:2px 2px 4px rgba(0,0,0,.6) }
    .container { max-width:1200px; margin:0 auto; display:flex; flex-direction:column; align-items:center; gap:20px }
    #controls { background:rgba(0,0,0,.6); padding:20px 30px; border-radius:12px; display:flex; gap:15px; flex-wrap:wrap; justify-content:center }
    #controls button { background:#ff6f61; border:none; padding:15px 25px; border-radius:8px; font-size:1.1em; color:#fff; font-weight:700; cursor:pointer; transition:.2s }
    #controls button:hover:not(:disabled) { background:#ff8a7d; transform:translateY(-2px) }
    #controls button:disabled { opacity:.5; cursor:not-allowed }
    #balance { font-size:1.5em; font-weight:700 }
    #game-canvas { width:100%; max-width:800px; height:600px; background:#1099bb; border:4px solid #fff; border-radius:12px }
    #logs { background:rgba(0,0,0,.7); width:100%; max-width:800px; height:150px; overflow-y:auto; padding:10px; border-radius:8px; text-align:left; font-size:.9em }
    #logs p { margin-bottom:5px }
  </style>
</head>
<body>
  <h1>Interactive Blackjack</h1>
  <div class="container">
    <div id="controls">
      <button id="btnNewGame">New Game</button>
      <button id="btnHit"    disabled>Hit</button>
      <button id="btnStand"  disabled>Stand</button>
      <button id="btnBalance">Check Balance</button>
    </div>
    <div id="balance">Balance: --</div>
    <canvas id="game-canvas"></canvas>
    <div id="logs"></div>
  </div>

  <script>
  (function(){
    // State
    let sessionId = '';
    let playerHand = [], dealerHand = [null,null];
    let gameState = 'idle';

    // DOM
    const btnNew   = document.getElementById('btnNewGame');
    const btnHit   = document.getElementById('btnHit');
    const btnStand = document.getElementById('btnStand');
    const btnBal   = document.getElementById('btnBalance');
    const balanceD = document.getElementById('balance');
    const logs     = document.getElementById('logs');

    // Card parser
    const suitMap = { Hearts:'♥', Diamonds:'♦', Clubs:'♣', Spades:'♠' };
    function parseCard(str){
      const m = str.match(/^(.+?)(Hearts|Diamonds|Clubs|Spades)$/);
      return m ? { rank:m[1], suit:suitMap[m[2]] } : { rank:'?', suit:'' };
    }
    function cardToString(c){ return c.rank + c.suit }
    function handValue(h){
      let sum=0, aces=0;
      h.forEach(c=>{
        if(c.rank==='A'){ sum+=11; aces++ }
        else if(/^[KQJ]$/.test(c.rank)){ sum+=10 }
        else sum+=+c.rank;
      });
      while(sum>21 && aces>0){ sum-=10; aces-- }
      return sum;
    }

    // Logging & UI
    function log(msg){
      const p = document.createElement('p');
      p.textContent = msg;
      logs.appendChild(p);
      logs.scrollTop = logs.scrollHeight;
    }
    function resetUI(){
      logs.innerHTML = '';
      balanceD.textContent = 'Balance: --';
    }
    function setBalance(b){
      balanceD.textContent = 'Balance: ' + b;
    }
    function updateButtons(){
      btnNew.disabled   = (gameState==='playerTurn'||gameState==='dealerTurn');
      btnHit.disabled   = (gameState!=='playerTurn');
      btnStand.disabled = (gameState!=='playerTurn');
    }

    // PIXI Setup
    const app = new PIXI.Application({
      view: document.getElementById('game-canvas'),
      width:800, height:600, backgroundColor:0x1099bb
    });
    function render(){
      app.stage.removeChildren();
      // Dealer: two slots
      [0,1].forEach(i=>{
        let txt = '??';
        if(i===0) txt = cardToString(dealerHand[0]);
        if(i===1 && gameState!=='playerTurn' && dealerHand[1]) 
          txt = cardToString(dealerHand[1]);
        const style = {
          fontFamily:'Roboto',
          fontSize: i===0?24:32,
          fill: i===0?'#fff':'#000',
          stroke:'#fff', strokeThickness:2
        };
        const t = new PIXI.Text(i===0 ? 'Dealer: '+txt : txt, style);
        t.x = 50 + i*150;
        t.y = i===0?20:60;
        app.stage.addChild(t);
      });
      // Player
      const pt = new PIXI.Text(
        'You: '+playerHand.map(cardToString).join(', ')
        +' ('+handValue(playerHand)+')',
        { fontFamily:'Roboto', fontSize:24, fill:'#fff' }
      );
      pt.x=50; pt.y=300;
      app.stage.addChild(pt);
      playerHand.forEach((c,i)=>{
        const ct = new PIXI.Text(cardToString(c),
          { fontFamily:'Roboto', fontSize:32, fill:'#000', stroke:'#fff', strokeThickness:2 });
        ct.x = 50 + i*60;
        ct.y = 350;
        app.stage.addChild(ct);
      });
    }

    // Round end → refresh balance
    async function conclude(){
      const r = await fetch('/api/wallet?user_id=testuser');
      const w = await r.json();
      log('Balance: '+w.balance);
      setBalance(w.balance);
    }

    // Button handlers
    btnNew.onclick = async ()=>{
      resetUI();
      const res = await fetch('/api/new_game');
      const d = await res.json();
      sessionId    = d.session_id;
      playerHand   = d.player_cards.map(parseCard);
      dealerHand   = [ parseCard(d.dealer_card), null ];
      gameState    = 'playerTurn';
      log('NewGame: '+JSON.stringify(d));
      updateButtons();
      render();
    };

    btnHit.onclick = async ()=>{
      const res = await fetch(`/api/hit?session_id=${sessionId}`);
      const d = await res.json();
      playerHand = d.player_cards.map(parseCard);
      log('Hit: '+JSON.stringify(d));
      if(d.finished){ 
        gameState = 'finished';
        await conclude();
      }
      updateButtons();
      render();
    };

    btnStand.onclick = async ()=>{
      const res = await fetch(`/api/stand?session_id=${sessionId}`);
      const d = await res.json();
      dealerHand = d.dealer_cards.map(parseCard);
      log('Stand: '+JSON.stringify(d));
      gameState = 'finished';
      updateButtons();
      render();
      await conclude();
    };

    btnBal.onclick = conclude;

    // Init
    updateButtons();
  })();
  </script>
</body>
</html>
